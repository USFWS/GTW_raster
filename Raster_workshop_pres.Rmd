---
title: "Geospatial Training Workshop: \nRaster Processing in R"
author: "Adam Smith"
date: "1-2 March 2016"
output:
  ioslides_presentation:
    keep_md: true
    css: workshop.css
    fig_caption: yes
    highlight: pygments
    logo: usfws_refuges_logos.png
    transition: faster
    widescreen: yes
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(message=FALSE, warning=FALSE, echo=TRUE,
                      fig.width = 10,
                      fig.height = 5,
                      comment = "#>",  
                      collapse = TRUE)
```
## Module Overview

- Use and benefits of R as a GIS tool
- Basic I/O operations with raster (and vector)
- Basic raster operations/conversions
- Simple raster calculations
- Raster &harr; vector conversion
- Some raster/vector interactions

**Prerequisites**

- Comfortable working in R  
- Some experience with raster (and vector)

## Acknowledgments

This material represents a conglomeration of original material as well as parts adapted from:
  
  - NEON's [Data Tutorial Series](http://neondataskills.org/tutorial-series/)
- Francesco Tonini's [Introduction to using R as a GIS](https://github.com/f-tonini/GIS610_SpatialR)
- Barry Rowlingson's [UseR 2012 Spatial Data Workshop](http://www.maths.lancs.ac.uk/~rowlings/Teaching/UseR2012/)
- Robert Hijmans's [`raster` package vignette](https://cran.r-project.org/web/packages/raster/raster.pdf)

This material is by no means comprehensive. 

The list above is a good place to start for more details.

## Raster data

- Divides space in cells (pixels; rectangles) of equal size
    - for a given coordinate reference system (CRS)
- Can represent continuous or categorical data
    - examples?

<div class="centered">
  ![](./images/raster_concept.png)
</div>
  
## Vector data

- Discrete spatial data (points, lines, polygons)
- Think `shapefile` with/without attributes

<div class="centered">
  ![](./images/pnt_line_poly.png)
</div>
  
----
  
<div class="centered">
```{r NCTC, eval=FALSE, echo=FALSE}
library(raster); library(rgdal); library(leaflet)
NCTC <- readOGR("./data", "nctc_boundary", verbose = FALSE)
dem <- raster('./data/dem.img')
pal <- colorNumeric(terrain.colors(10), values(dem))

# Create map
leaflet() %>%
  addTiles("http://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}",
           group = "Aerial") %>%
  addTiles("http://server.arcgisonline.com/ArcGIS/rest/services/World_Topo_Map/MapServer/tile/{z}/{y}/{x}",
           group = "Terrain") %>%
  addRasterImage(dem, colors = terrain.colors(10), opacity = 0.65, group = "Elevation",
                 maxBytes = 8 * 1024 * 1024) %>%
  addMarkers(lng = -77.803947, lat = 39.487872, 
             popup = "YOU ARE HERE") %>%
  addPolygons(data = NCTC, fillOpacity = 0) %>%
  hideGroup("Elevation") %>%
  addLegend(pal = pal, values = values(dem), title = "Elevation (m)") %>%
  addLayersControl(baseGroups = c("Aerial", "Terrain"),
                   overlayGroups = c("Elevation"),
                   options = layersControlOptions(collapsed = FALSE))

```
</div>
  
## R as a GIS
  
<div class="centered">
  ![Source: WageningenUR](./images/system_overview.png)
</div>
  
## RStudio

- [too many conveniences to list...](http://www.rstudio.com/wp-content/uploads/2016/01/rstudio-IDE-cheatsheet.pdf)
- R Projects
  
## Navigating files in R

- Pathnames are character strings
    - single (`'single'`) or double (`"double"`) quotes work

> - Pathnames in R require forward slashes `/`  
>      - `"C:/This/pathname/is/formatted/correctly.txt"`
    
> - Working directory
>      - view current with `getwd()`; should be "D:/GTW_raster"
>      - change with `setwd()`
    
> - Using pathnames relative to the working directory
>      - current directory denoted with a single period `.`; `setwd("./data")`
>      - go back a directory with two periods `..`; `setwd("..")`

----

<div id="handson" markdown="1">
  
<h2> Hands On #1: R Projects and relative pathnames</h2>

1. In R Studio, create an R Project for today's module
    - Find Source, Console, Environment, and Files/Plots panes
    - `File` &rarr; `New Project...` &rarr; `Existing Directory`
    - Navigate to "D:/GTW_raster"
    - Click `Create Project`
2. Experiment with relative pathnames
    - change working directory to `data` folder: `setwd("relative/path")`
    - view list of files: `dir()`
    - change working directory back to the `GTW_raster` folder
</div>

# R Basics 

## Object assignment (variables)
- Left-facing arrow (`<-`) or equals sign (`=`)

```{r}
a_string <- "NCTC" 
a_string

a_number = 3
a_number
```  

## Data types
- Main types: `numeric`, `character` (string), and `logical` (TRUE/FALSE)

```{r}
class(a_string)
is.numeric(a_number)

# To specify an integer (default = numeric), use `L` after the number
an_integer <- 5L
class(an_integer)

class(TRUE)
```

## Data types
- `factor` (another way of storing character data; categorical data)

```{r}
a_factor <- factor(c("Each", "unique", "string", "will", "be", "a", "level"))
str(a_factor)
levels(a_factor)
```  

- `Dates` (another time maybe...)
    - [`lubridate`](https://cran.r-project.org/web/packages/lubridate/index.html) package makes this considerably easier  

## Missing Data in R

- `NA`
    - used as you might expect; data is defined but missing

```{r}
bird_counts <- c(1, 5, NA, 8, NA)
bird_counts
```
    
- `NULL`
    - absence of anything; undefined
    - commonly used as default for optional function parameters

```{r}
bird_counts <- c(1, 5, NULL, 8, NULL)
bird_counts
```

## Data Structures

- Vectors: 1D arrays; can hold `numeric`, `character`, or `logical` data

> - Matrices: 2D vectors (rows and columns); only `numeric` data
>      - single-band rasters

> - Data Frames: 2D (rows and columns); most common data structure
>      - each column is a vector and MUST be the same length
>      - mixed data types allowed

> - Arrays: matrices (`numeric`) with 3D+
>      - multi-band rasters

> - Lists: containers to any combination of objects or data structures

# Importing vector and raster data

## Required R Packages

- Vector data: `rgdal` and `sp`
- Raster data: `raster`
- Install with `install.packages("package name")`
- Load functionality with `library()` or `require()`

```{r packages, message = FALSE, warning=FALSE}
# These packages should all be installed on your machine
library(rgdal)        # R bindings for the Geospatial Data Abstraction Library    
library(raster)       # Primary package for working with rasters in R
# library(sp)         # For vector data/shapefiles; loaded with raster package
library(rasterVis)    # Some handy visualization functions for raster data
```

## Getting Help

`R` offers a comprehensive built-in help system. At the program's command prompt you can use any of the following:

* **help.start()**   # general help  
* **?foo**           # help about function foo  
* **apropos("foo")** # list all functions containing string foo  
* **example(foo)**   # show an example of function foo (if available)


## Import Shapefiles

We will use the `rgdal` package to work with vector data in `R`. Notice that the
`sp` package automatically loads when `rgdal` is loaded. We will also load the
`raster` package so we can explore raster and vector spatial metadata using similar commands.

```{r load-libraries, eval=FALSE }

# load required libraries
# for vector work; sp package will load with rgdal.
library(rgdal)  
# for metadata/attributes- vectors or rasters
library(raster) 

# set working directory to the directory location on your computer where
# you downloaded and unzipped the data files for the lesson
# setwd("pathToDirHere")
```

The shapefiles that we will import are:

* A polygon shapefile representing our field site boundary, 
* A line shapefile representing roads, and 
* A point shapefile representing the location of the Fisher   
<a href="http://www.neoninc.org/science-design/collection-methods/flux-tower-measurements" target="_blank">flux tower</a> 
located at the
<a href="http://www.neoninc.org/science-design/field-sites/harvard-forest" target="_blank"> NEON Harvard Forest field site</a>.

The first shapefile that we will open contains the boundary of our study area
(or our Area Of Interest or AOI, hence the name `aoiBoundary`). To import 
shapefiles we use the `R` function `readOGR()`.

`readOGR` requires two components:

1. The directory where our shapefile lives: `NEON-DS-Site-Layout-Files/HARV`
2. The name of the shapefile (without the extension): `HarClip_UTMZ18`

Let's import our AOI.

```{r Import-Shapefile, eval=FALSE}

# Import a polygon shapefile: readOGR("path","fileName")
# no extension needed as readOGR only imports shapefiles
aoiBoundary_HARV <- readOGR("NEON-DS-Site-Layout-Files/HARV",
                            "HarClip_UTMZ18")

```

## Spatial Metadata
Key metadata for all shapefiles include:

1. **Object Type:** the class of the imported object. 
2. **Coordinate Reference System (`CRS`):** the projection of the data.
3. **Extent:** the spatial extent (geographic area that the shapefile covers) of 
the shapefile. Note that the spatial extent for a shapefile represents the 
extent for ALL spatial objects in the shapefile.

We can view shapefile metadata using the `class`, `crs` and `extent` methods:

```{r view-metadata, eval=FALSE }
# view just the class for the shapefile
class(aoiBoundary_HARV)

# view just the crs for the shapefile
crs(aoiBoundary_HARV)

# view just the extent for the shapefile
extent(aoiBoundary_HARV)

# view all metadata at same time
aoiBoundary_HARV
```

