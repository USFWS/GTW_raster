---
title: "Raster Processing in R"
subtitle: "Geospatial Training Workshop"
author: Adam Smith, U.S. Fish & Wildlife Service
date: "1-2 March 2016"
output:
  ioslides_presentation:
    css: workshop.css
    fig_caption: yes
    highlight: pygments
    logo: usfws_refuges_logos.png
    transition: faster
    widescreen: yes
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(message=FALSE, warning=FALSE, echo=TRUE,
                      fig.width = 10,
                      fig.height = 5,
                      comment = "#>",  
                      collapse = TRUE)
```
## Module Overview

Follow along at [rpubs.com/adamsmith_fws/GTW_raster](http://rpubs.com/adamsmith_fws/GTW_raster)

- Use and benefits of R as a GIS tool
- Basic I/O operations with raster (and vector)
- Basic raster operations/conversions
- Simple raster calculations
- Raster &harr; vector conversion
- Some raster/vector interactions

**Prerequisites**

- Comfortable working in R  
- Some experience with raster (and vector)

## Acknowledgments

This material represents a conglomeration of original material as well as parts adapted from:
  
- NEON's [Data Tutorial Series](http://neondataskills.org/tutorial-series/)
- Francesco Tonini's [Introduction to using R as a GIS](https://github.com/f-tonini/GIS610_SpatialR)
- Wageningen UR's [Geoscripting workshop](https://geoscripting-wur.github.io/)
- Robert Hijmans's [`raster` package vignette](https://cran.r-project.org/web/packages/raster/raster.pdf)

Today's module is by no means comprehensive.  

For more details, the list above is a good place to start.

See also: [Applied Spatial Data Analysis with R](http://www.springer.com/us/book/9781461476177)

# R Data Types

## Object assignment (variables)
- Left-facing arrow (`<-`) or equals sign (`=`)
    - in RStudio, `alt + hyphen` for `<-`

```{r}
a_number = 3
a_number

a_string <- "NCTC" 
a_string
```  

## Common data types
- `numeric`, `character` (string), and `logical` (TRUE/FALSE)

```{r}
is.numeric(a_number)
class(a_string)

# To specify an integer (default = numeric), use `L` after the number
an_integer <- 5L
class(an_integer)

a_logical <- TRUE
class(a_logical)
```

## Additional data types
- `factor` (another way of storing character data; categorical data)

```{r}
a_factor <- factor(c("Each", "unique", "string", "will", "be", "a", "level"))
str(a_factor)
levels(a_factor)
```  

- `Dates` (another time maybe...)
    - [`lubridate`](https://cran.r-project.org/web/packages/lubridate/index.html) package makes this considerably easier  

## Missing Data

- `NA`
    - used as you might expect; data is defined but missing

```{r}
bird_counts <- c(1, 5, NA, 8, NA)
bird_counts
```
    
- `NULL`
    - absence of anything; undefined
    - commonly used as default for optional function parameters

```{r}
bird_counts <- c(1, 5, NULL, 8, NULL)
bird_counts
```

# Data Structures

## Vectors
- 1D; can hold `numeric`, `character`, or `logical` data
- single data type
    
```{r}
eg <- c("This", "is", "a", "character", "vector")
eg
eg2 <- c(1, 2, 3, 4, 5, 6, 7)
eg2
is.vector(eg)
is.vector(eg2)
```

## Matrices
- `numeric` vector stored in 2 dimensions, rows & columns (e.g., x-y direction)
- single-band rasters (with addn'l spatial metadata)

```{r}
data <- rnorm(8) # `rnorm` generates random normal deviates; see `?rnorm`
mat <- matrix(data, nrow = 2, ncol = 4)
mat
is.matrix(mat)
```

## Data Frames
- 2D (rows and columns); most common data structure
- **each column** is a distinct vector (*cf* matrices); all columns *same* length
- mixed data types allowed

```{r}
# By default, R coerces character vectors to factors
df <- data.frame(char = c("a", "b"), num = rnorm(2), stringsAsFactors = FALSE)
df
str(df) # `str` is a useful function for exploring the structure of an object
```

## Arrays

- `numeric` vector stored in 1 or more dimensions (`dim` argument, see below)
- multi-band rasters (& spatial metadata)

```{r}
arr <- array(rnorm(8), dim = c(2, 2, 2))
arr
```

## Lists

- containers for any combination of objects or data structures

```{r}
lst <- list(eg, mat, df, arr, list(eg, eg2))
str(lst) 
```

## Navigating files in R

- Pathnames are character strings
    - single (`'single'`) or double (`"double"`) quotes work

> - Pathnames in R require forward slashes `/`  
>      - `"C:/This/pathname/is/formatted/correctly.txt"`
    
> - Working directory (i.e., your current location)
>      - view with `getwd()`
>      - change with `setwd()`
    
> - Using pathnames relative to the working directory
>      - current directory denoted with a single period `.`; `setwd("./data")`
>      - go back a directory with two periods `..`; `setwd("..")`

## Getting Help in R

- `?function` will give you the associated help page (`?proj4string`)
- `example(function)` runs an example(s) of the function, if available
- `??searchterm` searches in all packages on CRAN (`??spTransform`)
- [rseek.org](http://rseek.org) is the R Google
- [Google](http://www.google.com) your error message with package ("Failure during raster IO" raster R)
- Search tags in [Stack Overflow](http://stackoverflow.com/) (e.g., [R] [raster] [projection])
- [StackExchange](http://stats.stackexchange.com): like Stack Overflow but for statistics 
- [Crantastic](http://crantastic.org): search through packages on CRAN 

## RStudio (Integrated Development Environment)

- [too many conveniences to list...](http://www.rstudio.com/wp-content/uploads/2016/01/rstudio-IDE-cheatsheet.pdf)
- R Projects

<div class="centered">
  ![](./images/RStudio.png)
</div>

----

<div id="handson" markdown="1">
  
<h2>Hands On #1: R Project, object creating, and relative pathnames</h2>

1. In R Studio, create an R Project for today's module
    - `File` &rarr; `New Project...` &rarr; `Existing Directory` 
    - Navigate to "D:/GTW_raster" and click `Create Project`
2. Explore help files (e.g., `?c`, `?vector`, `?list`)
3. Create `numeric` and `character` vectors; store in `data.frame`
4. Create a `list` of multiple `data.frame`s
5. Experiment with relative pathnames
    - change working directory to `data` folder: `setwd("relative/path")`
    - view list of files: `list.files()`
    - change working directory back to the `GTW_raster` folder
</div>


# R as a GIS
 
---- 
<div class="centered">
  ![Source: WageningenUR](./images/system_overview.png)
</div>

## Spatial Data I/O in R

Vector data

- I/O operations made possible by **OGR Simple Feature Library**
- Bindings in R provided by `rgdal` package
- Classes and methods provided by `sp` package
- Variety of vector file formats (e.g., ESRI Shapefiles, kml)
- Geometries operations (buffering, overlaying, area calculations, etc.)
    - `rgeos` package &rarr; bindings to **Geometry Engine Open Source** library

Raster data
- I/O operations made possible by **Geospatial Data Abstraction Library**
- binding in R provided by `rgdal` package
- classes and methods provided by `raster` package

Additional resources
- [CRAN Task View: Analysis of Spatial Data](https://cran.r-project.org/web/views/Spatial.html)

<div class="notes">
The GDAL library, of which the OGR library is a part, is the most useful freely-available library for reading and writing geospatial data. 
</div>

## Raster data

- Divides space in cells (pixels; rectangles) of equal size
    - for a given coordinate reference system (CRS)
- Can represent continuous or categorical data
    - examples?

<div class="centered">
  ![](./images/raster_concept.png)
</div>
  
## Vector data

- Discrete spatial data (points, lines, polygons)
- Think `shapefile` with/without attributes

<div class="centered">
  ![](./images/pnt_line_poly.png)
</div>
  
----
  
<div class="centered">
```{r NCTC, eval=FALSE, echo=FALSE}
library(raster); library(rgdal); library(leaflet)
NCTC <- readOGR("./data", "nctc_boundary", verbose = FALSE)
dem <- raster('./data/dem.img')
pal <- colorNumeric(terrain.colors(10), values(dem))

# Create map
leaflet() %>%
  addTiles("http://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}",
           group = "Aerial") %>%
  addTiles("http://server.arcgisonline.com/ArcGIS/rest/services/World_Topo_Map/MapServer/tile/{z}/{y}/{x}",
           group = "Terrain") %>%
  addRasterImage(dem, colors = terrain.colors(10), opacity = 0.65, group = "Elevation",
                 maxBytes = 8 * 1024 * 1024) %>%
  addMarkers(lng = -77.803947, lat = 39.487872, 
             popup = "YOU ARE HERE") %>%
  addPolygons(data = NCTC, fillOpacity = 0) %>%
  hideGroup("Elevation") %>%
  addLegend(pal = pal, values = values(dem), title = "Elevation (m)") %>%
  addLayersControl(baseGroups = c("Aerial", "Terrain"),
                   overlayGroups = c("Elevation"),
                   options = layersControlOptions(collapsed = FALSE))

```
</div>
  
# Importing data into R | Data Tables and Spatial Data

## Required R Packages

- Vector data: `rgdal` and `sp`
- Raster data: `raster` and `rasterVis`
- Install with `install.packages("package name")`
- Load functionality with `library()` or `require()`

```{r packages, message = FALSE, warning=FALSE}
# These packages should all be installed on your machine
library(rgdal)        # R bindings for the Geospatial Data Abstraction Library    
library(raster)       # Primary package for working with rasters in R
# library(sp)         # For vector data/shapefiles; loaded with raster package
library(rasterVis)    # Some handy visualization functions for raster data
library(dplyr)        # Handy tools for data manipulation
```

## Import Data Tables

- *easiest* import format is plain text, especially CSV (`read.table` or `read.csv`)
    - R imports as a `data.frame` by default
- many other options
    - R's native structure (see `?save`)
    - databases (MySQL, SQLite, Access)
    - Excel, SAS, SPSS, DBF, etc.

## Example CSV import

```{r}
download.file(url = "http://tinyurl.com/testCSV", destfile = "./data/test.csv")
test <- read.table("./data/test.csv", header = TRUE, sep = ",")
test <- read.csv("./data/test.csv", header = TRUE)
class(test)
glimpse(test)
```


```{r}
download.file(url = "https://github.com/adamdsmith/GTW_raster/raw/master/Data/wv.zip",
              destfile = "./data/wvshape.zip")
unzip("./data/wvshape.zip", exdir = "./data")
wv <- readOGR(dsn = "./data",   # folder name (`dsn` argument)
              layer = "wv")     # file name without extension
```

## Examine loaded shapefile

```{r, eval=FALSE}
# View description. Note the coordinate bounding box and projection info
summary(wv)
# just look at projection
proj4string(cp.poly)
# make a simple plot
plot(cp.poly, axes=T, col='blue', main = "CO Plateau")
```

## Spatial Metadata

Key metadata for all shapefiles include:

1. **Object Type:** the class of the imported object. 
2. **Coordinate Reference System (`CRS`):** the projection of the data.
3. **Extent:** the spatial extent (geographic area that the shapefile covers) of 
the shapefile. Note that the spatial extent for a shapefile represents the 
extent for ALL spatial objects in the shapefile.

We can view shapefile metadata using the `class`, `crs` and `extent` methods:

```{r view-metadata, eval=FALSE }
# view just the class for the shapefile
class(aoiBoundary_HARV)

# view just the crs for the shapefile
crs(aoiBoundary_HARV)

# view just the extent for the shapefile
extent(aoiBoundary_HARV)

# view all metadata at same time
aoiBoundary_HARV
```

download.file(url = 'https://raw.githubusercontent.com/adamdsmith/GTW_raster/master/test_script.R', destfile = 'downloadOK.R', method = 'auto')
